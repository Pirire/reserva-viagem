<script>
// --- Código existente permanece inalterado ---
// stripe
const stripe = Stripe("pk_test_xxxxxxxxxxxxxxxxxxxxx"); // substitua pela sua chave pública real

document.getElementById("confirmarPagamento").addEventListener("click", async () => {
  try {
    // Envia os dados da reserva para o backend para criar a PaymentIntent
    const response = await fetch(`${backendURL}/create-payment-intent`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amount: Math.round(ultimoCusto * 100), // valor em cêntimos
        currency: "eur",
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value,
        partida: document.getElementById("partida").value,
        destino: document.getElementById("destino").value,
        datahora: document.getElementById("datahora").value,
        contato: document.getElementById("contato").value,
        codigoReserva: document.getElementById("resCodigo").textContent
      })
    });

    const data = await response.json();
    if (!data.clientSecret) {
      document.getElementById("popupStatus").textContent = "❌ Erro ao iniciar pagamento. Verifique o servidor.";
      document.getElementById("popupStatus").classList.remove("text-green-700");
      document.getElementById("popupStatus").classList.add("text-red-600");
      return;
    }

    // Confirmação do pagamento (teste com cartão Stripe)
    const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
      payment_method: {
        card: { token: "tok_visa" }, // ⚠️ apenas para teste; para produção use Stripe Elements
        billing_details: {
          name: document.getElementById("nome").value,
          email: document.getElementById("email").value
        }
      }
    });

    if (error) {
      document.getElementById("popupStatus").textContent = "❌ Falha no pagamento: " + error.message;
      document.getElementById("popupStatus").classList.remove("text-green-700");
      document.getElementById("popupStatus").classList.add("text-red-600");
    } else if (paymentIntent.status === "succeeded") {
      document.getElementById("popupStatus").textContent = "✅ Pagamento concluído com sucesso!";
      document.getElementById("popupStatus").classList.remove("text-red-600");
      document.getElementById("popupStatus").classList.add("text-green-700");
    }
  } catch (err) {
    console.error(err);
    document.getElementById("popupStatus").textContent = "❌ Erro inesperado no pagamento.";
    document.getElementById("popupStatus").classList.remove("text-green-700");
    document.getElementById("popupStatus").classList.add("text-red-600");
  }
});
</script>
