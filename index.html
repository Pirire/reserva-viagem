<<<<<<< HEAD
import express from "express";
import path from "path";
import basicAuth from "express-basic-auth";
import dotenv from "dotenv";
import mongoose from "mongoose";
import { fileURLToPath } from "url";
import Reserva from "./models/Reserva.js";
import Stripe from "stripe";

dotenv.config();
const app = express();
const PORT = process.env.PORT || 10000;

// Corrigir __dirname em ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Conexão MongoDB
mongoose.connect(process.env.MONGODB_URI)
  .then(() => console.log("MongoDB conectado ✅"))
  .catch(err => console.error("❌ Erro ao conectar no MongoDB", err));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Servir arquivos estáticos do frontend
app.use(express.static(path.join(__dirname, "public")));

// Servir o index.html atualizado
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "index.html"));
});

// Rotas API de reservas
app.get("/reservas", async (req, res) => {
  try {
    const reservas = await Reserva.find().sort({ createdAt: -1 });
    res.json({ reservas });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Erro ao buscar reservas" });
  }
});

// Atualizar status de envio
app.patch("/reservas/:id/motorista", async (req, res) => {
  try {
    const reserva = await Reserva.findById(req.params.id);
    if (!reserva) return res.status(404).json({ error: "Reserva não encontrada" });

    reserva.paraMotorista = !reserva.paraMotorista;
    await reserva.save();

    res.json({ message: "Status atualizado com sucesso" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Erro ao atualizar status" });
  }
});

// Proteção painel admin
app.use("/admin", basicAuth({
  users: { [process.env.ADMIN_USER]: process.env.ADMIN_PASS },
  challenge: true,
}));

// Stripe
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

// Checkout sem multiplicar valor por 100
app.post("/checkout", async (req, res) => {
  try {
    const { nome, email, categoria, partida, destino, datahora, valor } = req.body;

    // Criar sessão de pagamento no Stripe
    const session = await stripe.checkout.sessions.create({
      payment_method_types: ["card"],
      customer_email: email,
      line_items: [
        {
          price_data: {
            currency: "eur",
            product_data: { name: `Reserva ${categoria}` },
            unit_amount: Math.round(valor * 100), // valor em centavos
          },
          quantity: 1,
        },
      ],
      mode: "payment",
      success_url: `${process.env.FRONTEND_URL}/?success=true`,
      cancel_url: `${process.env.FRONTEND_URL}/?canceled=true`,
    });

    res.json({ url: session.url });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Erro ao criar sessão Stripe" });
  }
});

app.listen(PORT, () => console.log(`Servidor rodando em http://localhost:${PORT}`));

<!-- ... restante do seu código igual ... -->

<script>
const backendURL = "https://reserva-backend-uu52.onrender.com";
let precoCategoria=0, categoriaSelecionada="", ultimoCusto=0, partidaPlace=null, destinoPlace=null, codigoReservaAtual="", rotaTimer=null;

const etapa1=document.getElementById('etapa1');
const etapa2=document.getElementById('etapa2');
const btnContinuar=document.getElementById('btnContinuar');
const camposObrig=document.querySelectorAll('.campoObrigatorio');
const btnsCategoria=document.querySelectorAll('.btn-cat');

function checkCampos(){ 
  const preenchidos=Array.from(camposObrig).every(c=>c.value.trim()!=="");
  btnContinuar.disabled=!preenchidos;
  btnContinuar.className=preenchidos
    ?"w-full py-2 rounded-2xl bg-green-500 hover:bg-green-600 text-white font-bold"
    :"w-full py-2 rounded-2xl bg-gray-400 text-white font-bold";
}
camposObrig.forEach(c=>{
  c.addEventListener('input',checkCampos);
  c.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      const campos=Array.from(camposObrig);
      const idx=campos.indexOf(c);
      if(idx+1<campos.length) campos[idx+1].focus();
      else btnContinuar.focus();
    }
  });
});

btnContinuar.addEventListener('click',()=>{
  if(!Array.from(camposObrig).every(c=>c.value.trim()!=="")){ 
    camposObrig.forEach(c=>{if(!c.value.trim())c.classList.add('campoInvalido');});
    return;
  }
  etapa1.classList.add('hidden');
  etapa2.classList.remove('hidden');
});
document.getElementById('btn-voltarEtapa1').addEventListener('click',()=>{
  etapa2.classList.add('hidden');
  etapa1.classList.remove('hidden'); 
});

btnsCategoria.forEach(btn=>{
  btn.addEventListener('click',()=>{
    btnsCategoria.forEach(b=>{b.classList.remove('bg-green-600'); b.classList.add('bg-green-300');});
    btn.classList.remove('bg-green-300'); btn.classList.add('bg-green-600');
    precoCategoria=parseFloat(btn.dataset.preco);
    categoriaSelecionada=btn.dataset.nome;
    clearTimeout(rotaTimer);
    rotaTimer=setTimeout(calcularRota,1000);
  });
});

// Google Maps
let map, directionsService, directionsRenderer;
function initAutocomplete(){
  const partidaAC=new google.maps.places.Autocomplete(document.getElementById('partida'), {fields:["place_id","formatted_address","geometry"]});
  const destinoAC=new google.maps.places.Autocomplete(document.getElementById('destino'), {fields:["place_id","formatted_address","geometry"]});
  partidaAC.addListener('place_changed',()=>{ partidaPlace=partidaAC.getPlace(); calcularRotaDebounced(); });
  destinoAC.addListener('place_changed',()=>{ destinoPlace=destinoAC.getPlace(); calcularRotaDebounced(); });
  initMap();
}
function initMap(){
  map=new google.maps.Map(document.getElementById("map"), {zoom:7, center:{lat:38.7169,lng:-9.139}});
  directionsService=new google.maps.DirectionsService();
  directionsRenderer=new google.maps.DirectionsRenderer({preserveViewport:false});
  directionsRenderer.setMap(map);
}
function calcularRotaDebounced(){ clearTimeout(rotaTimer); rotaTimer=setTimeout(calcularRota,1000);}
function calcularRota(){
  const origem=partidaPlace?{placeId:partidaPlace.place_id}:document.getElementById("partida").value.trim();
  const destino=destinoPlace?{placeId:destinoPlace.place_id}:document.getElementById("destino").value.trim();
  if(!origem||!destino||precoCategoria===0) return;
  directionsService.route({origin:origem,destination:destino,travelMode:google.maps.TravelMode.DRIVING},(res,status)=>{
    if(status==="OK"){
      directionsRenderer.setDirections(res);
      let km=0;
      res.routes[0].legs.forEach(l=>{ km+=l.distance.value/1000; });
      ultimoCusto=(km*precoCategoria).toFixed(2);
      document.getElementById("infoViagem").textContent=`Distância: ${km.toFixed(2)} km | Valor: ${ultimoCusto} €`;
      document.getElementById("OK").disabled=false;
      document.getElementById("OK").className="w-full py-2 rounded-2xl bg-green-500 hover:bg-green-600 text-white font-bold";
      document.getElementById("btn-cancelar").disabled=false;
    }
  });
}

document.getElementById("btnLocalizacao").addEventListener("click",()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};
      new google.maps.Geocoder().geocode({location:latlng},(results,status)=>{
        if(status==="OK"&&results[0]){
          document.getElementById("partida").value=results[0].formatted_address;
          partidaPlace=results[0]; checkCampos(); calcularRotaDebounced();
        }
      });
    });
  }
});

document.getElementById("OK").addEventListener("click",()=>{
  codigoReservaAtual="RM-"+Math.random().toString(36).substring(2,6).toUpperCase();
  document.getElementById('resNome').textContent=document.getElementById('nome').value;
  document.getElementById('resEmail').textContent=document.getElementById('email').value;
  document.getElementById('resContato').textContent=document.getElementById('contato').value;
  document.getElementById('resCategoria').textContent=categoriaSelecionada;
  document.getElementById('resValor').textContent=ultimoCusto; // valor mostrado
  document.getElementById('resPartida').textContent=document.getElementById('partida').value;
  document.getElementById('resPartida').href="https://www.google.com/maps/search/"+encodeURIComponent(document.getElementById('partida').value);
  document.getElementById('resDestino').textContent=document.getElementById('destino').value;
  document.getElementById('resDestino').href="https://www.google.com/maps/search/"+encodeURIComponent(document.getElementById('destino').value);
  document.getElementById('resData').textContent=document.getElementById('datahora').value;
  document.getElementById('resCodigo').textContent=codigoReservaAtual;
  document.getElementById('popupResumo').classList.remove('hidden');
});

document.getElementById("btn-voltar").addEventListener("click",()=>{ document.getElementById('popupResumo').classList.add('hidden'); });
document.getElementById("btn-fecharResumo").addEventListener("click",()=>{ document.getElementById('popupResumo').classList.add('hidden'); });

// ✅ Stripe - enviar valor removendo apenas o ponto (ex: "12.00" -> 1200)
document.getElementById("confirmarPagamento").addEventListener("click", async () => {
  const btn = document.getElementById("confirmarPagamento");
  btn.disabled = true;
  btn.textContent = "Processando...";

  const nome = document.getElementById('nome').value;
  const email = document.getElementById('email').value;
  const categoria = categoriaSelecionada;
  const partida = document.getElementById('partida').value;
  const destino = document.getElementById('destino').value;
  const datahora = document.getElementById('datahora').value;

  const valorCentavos = parseInt(ultimoCusto.replace('.', '').replace(',', ''));

  if (isNaN(valorCentavos) || valorCentavos <= 0) {
    document.getElementById('popupStatus').textContent = "Erro: valor inválido!";
    btn.disabled = false;
    btn.textContent = "EFETUAR PAGAMENTO";
    return;
  }

  try {
    const res = await fetch(`${backendURL}/checkout`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nome, email, categoria, partida, destino, datahora, valor: valorCentavos }),
    });

    const session = await res.json();
    if (session.url) {
      window.location.href = session.url;
    } else {
      document.getElementById('popupStatus').textContent = "Erro ao iniciar pagamento.";
      btn.disabled = false;
      btn.textContent = "EFETUAR PAGAMENTO";
    }
  } catch (err) {
    console.error(err);
    document.getElementById('popupStatus').textContent = "Erro ao conectar com o servidor.";
    btn.disabled = false;
    btn.textContent = "EFETUAR PAGAMENTO";
  }
});

window.onload = () => { initAutocomplete(); checkCampos(); };
</script>

