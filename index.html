<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reserva de Viagem</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://maps.googleapis.com/maps/api/js?key=SUA_GOOGLE_API_KEY&libraries=places"></script>
</head>
<body>

  <!-- üü¢ Etapa 1 -->
  <div id="etapa1">
    <h2>Informa√ß√µes da Viagem</h2>
    <input id="nome" class="campoObrigatorio" placeholder="Nome completo">
    <input id="email" class="campoObrigatorio" placeholder="E-mail">
    <input id="contato" class="campoObrigatorio" placeholder="Contato">
    <input id="partida" class="campoObrigatorio" placeholder="Local de partida">
    <input id="destino" class="campoObrigatorio" placeholder="Destino">
    <input id="datahora" class="campoObrigatorio" type="datetime-local">
    <button id="btnLocalizacao">Usar minha localiza√ß√£o</button>
    <button id="btnContinuar" disabled>Continuar</button>
  </div>

  <!-- üü° Etapa 2 -->
  <div id="etapa2" class="hidden">
    <h2>Escolha de categoria</h2>
    <div id="categorias">
      <button class="btn-cat bg-green-300" data-nome="Econ√¥mico" data-preco="1.20">Econ√¥mico</button>
      <button class="btn-cat bg-green-300" data-nome="Executivo" data-preco="2.50">Executivo</button>
      <button class="btn-cat bg-green-300" data-nome="Luxo" data-preco="4.00">Luxo</button>
    </div>
    <p id="infoViagem">Dist√¢ncia e valor aparecer√£o aqui.</p>
    <button id="OK" disabled>OK</button>
    <button id="btn-voltarEtapa1">Voltar</button>
  </div>

  <!-- üßæ Pop-up de Resumo -->
  <div id="popupResumo" class="hidden">
    <div class="popup">
      <h3>Resumo da Viagem</h3>
      <p><strong>Nome:</strong> <span id="resNome"></span></p>
      <p><strong>Email:</strong> <span id="resEmail"></span></p>
      <p><strong>Contato:</strong> <span id="resContato"></span></p>
      <p><strong>Categoria:</strong> <span id="resCategoria"></span></p>
      <p><strong>Valor:</strong> <span id="resValor"></span> ‚Ç¨</p>
      <p><strong>Partida:</strong> <a id="resPartida" target="_blank"></a></p>
      <p><strong>Destino:</strong> <a id="resDestino" target="_blank"></a></p>
      <p><strong>Data/Hora:</strong> <span id="resData"></span></p>
      <p><strong>C√≥digo:</strong> <span id="resCodigo"></span></p>
      <p id="popupStatus" class="status"></p>
      <button id="confirmarPagamento">EFETUAR PAGAMENTO</button>
      <button id="btn-voltar">Voltar</button>
      <button id="btn-fecharResumo">Fechar</button>
    </div>
  </div>

  <!-- üåç Mapa -->
  <div id="map" style="width:100%; height:300px; margin-top:20px;"></div>

  <!-- üìú Seu script frontend -->
  <script>
    const backendURL = "https://reserva-backend-uu52.onrender.com";
    let precoCategoria = 0;
    let categoriaSelecionada = "";
    let ultimoCusto = 0;
    let partidaPlace = null;
    let destinoPlace = null;
    let codigoReservaAtual = "";
    let rotaTimer = null;

    const etapa1 = document.getElementById('etapa1');
    const etapa2 = document.getElementById('etapa2');
    const btnContinuar = document.getElementById('btnContinuar');
    const camposObrig = document.querySelectorAll('.campoObrigatorio');
    const btnsCategoria = document.querySelectorAll('.btn-cat');

    function checkCampos() {
      const preenchidos = Array.from(camposObrig).every(c => c.value.trim() !== "");
      btnContinuar.disabled = !preenchidos;
      btnContinuar.className = preenchidos
        ? "w-full py-2 rounded-2xl bg-green-500 hover:bg-green-600 text-white font-bold"
        : "w-full py-2 rounded-2xl bg-gray-400 text-white font-bold";
    }

    camposObrig.forEach(c => {
      c.addEventListener('input', checkCampos);
      c.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const campos = Array.from(camposObrig);
          const idx = campos.indexOf(c);
          if (idx + 1 < campos.length) campos[idx + 1].focus();
          else btnContinuar.focus();
        }
      });
    });

    btnContinuar.addEventListener('click', () => {
      etapa1.classList.add('hidden');
      etapa2.classList.remove('hidden');
    });

    document.getElementById('btn-voltarEtapa1').addEventListener('click', () => {
      etapa2.classList.add('hidden');
      etapa1.classList.remove('hidden');
    });

    btnsCategoria.forEach(btn => {
      btn.addEventListener('click', () => {
        btnsCategoria.forEach(b => { b.classList.remove('bg-green-600'); b.classList.add('bg-green-300'); });
        btn.classList.remove('bg-green-300');
        btn.classList.add('bg-green-600');
        precoCategoria = parseFloat(btn.dataset.preco);
        categoriaSelecionada = btn.dataset.nome;
        clearTimeout(rotaTimer);
        rotaTimer = setTimeout(calcularRota, 1000);
      });
    });

    let map, directionsService, directionsRenderer;
    function initAutocomplete() {
      const partidaAC = new google.maps.places.Autocomplete(document.getElementById('partida'), { fields: ["place_id", "formatted_address", "geometry"] });
      const destinoAC = new google.maps.places.Autocomplete(document.getElementById('destino'), { fields: ["place_id", "formatted_address", "geometry"] });
      partidaAC.addListener('place_changed', () => { partidaPlace = partidaAC.getPlace(); calcularRotaDebounced(); });
      destinoAC.addListener('place_changed', () => { destinoPlace = destinoAC.getPlace(); calcularRotaDebounced(); });
      initMap();
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), { zoom: 7, center: { lat: 38.7169, lng: -9.139 } });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ preserveViewport: false });
      directionsRenderer.setMap(map);
    }

    function calcularRotaDebounced() { clearTimeout(rotaTimer); rotaTimer = setTimeout(calcularRota, 1000); }

    function calcularRota() {
      const origem = partidaPlace ? { placeId: partidaPlace.place_id } : document.getElementById("partida").value.trim();
      const destino = destinoPlace ? { placeId: destinoPlace.place_id } : document.getElementById("destino").value.trim();
      if (!origem || !destino || precoCategoria === 0) return;
      directionsService.route({ origin: origem, destination: destino, travelMode: google.maps.TravelMode.DRIVING }, (res, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(res);
          let km = 0;
          res.routes[0].legs.forEach(l => { km += l.distance.value / 1000; });
          ultimoCusto = (km * precoCategoria).toFixed(2);
          document.getElementById("infoViagem").textContent = `Dist√¢ncia: ${km.toFixed(2)} km | Valor: ${ultimoCusto} ‚Ç¨`;
          document.getElementById("OK").disabled = false;
        }
      });
    }

    document.getElementById("OK").addEventListener("click", () => {
      codigoReservaAtual = "RM-" + Math.random().toString(36).substring(2, 6).toUpperCase();
      document.getElementById('resNome').textContent = document.getElementById('nome').value;
      document.getElementById('resEmail').textContent = document.getElementById('email').value;
      document.getElementById('resContato').textContent = document.getElementById('contato').value;
      document.getElementById('resCategoria').textContent = categoriaSelecionada;
      document.getElementById('resValor').textContent = ultimoCusto;
      document.getElementById('resPartida').textContent = document.getElementById('partida').value;
      document.getElementById('resPartida').href = "https://www.google.com/maps/search/" + encodeURIComponent(document.getElementById('partida').value);
      document.getElementById('resDestino').textContent = document.getElementById('destino').value;
      document.getElementById('resDestino').href = "https://www.google.com/maps/search/" + encodeURIComponent(document.getElementById('destino').value);
      document.getElementById('resData').textContent = document.getElementById('datahora').value;
      document.getElementById('resCodigo').textContent = codigoReservaAtual;
      document.getElementById('popupResumo').classList.remove('hidden');
    });

    document.getElementById("btn-voltar").addEventListener("click", () => { document.getElementById('popupResumo').classList.add('hidden'); });
    document.getElementById("btn-fecharResumo").addEventListener("click", () => { document.getElementById('popupResumo').classList.add('hidden'); });

    // üì§ Stripe
    document.getElementById("confirmarPagamento").addEventListener("click", async () => {
      const btn = document.getElementById("confirmarPagamento");
      btn.disabled = true;
      btn.textContent = "Processando...";

      const nome = document.getElementById('nome').value;
      const email = document.getElementById('email').value;
      const categoria = categoriaSelecionada;
      const partida = document.getElementById('partida').value;
      const destino = document.getElementById('destino').value;
      const datahora = document.getElementById('datahora').value;

      // Remover ponto para enviar em centavos
      const valorCentavos = parseInt(ultimoCusto.replace('.', '').replace(',', ''));

      if (isNaN(valorCentavos) || valorCentavos <= 0) {
        document.getElementById('popupStatus').textContent = "Erro: valor inv√°lido!";
        btn.disabled = false;
        btn.textContent = "EFETUAR PAGAMENTO";
        return;
      }

      try {
        const res = await fetch(`${backendURL}/checkout`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nome, email, categoria, partida, destino, datahora, valor: valorCentavos }),
        });

        const session = await res.json();
        if (session.url) {
          window.location.href = session.url;
        } else {
          document.getElementById('popupStatus').textContent = "Erro ao iniciar pagamento.";
          btn.disabled = false;
          btn.textContent = "EFETUAR PAGAMENTO";
        }
      } catch (err) {
        console.error(err);
        document.getElementById('popupStatus').textContent = "Erro ao conectar com o servidor.";
        btn.disabled = false;
        btn.textContent = "EFETUAR PAGAMENTO";
      }
    });

    window.onload = () => { initAutocomplete(); checkCampos(); };
  </script>
</body>
</html>
