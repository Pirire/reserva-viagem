<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Admin - Reservas</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background-color: #f3f4f6; }
  .card { background: white; border-radius: 1rem; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .grid-card { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
  .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
  .btn-enviado { background-color: #10b981; color: white; }
  .btn-nao { background-color: #f87171; color: white; }
  .link-viagem { text-decoration: underline; color: #2563eb; }
</style>
</head>
<body class="p-4">

<h1 class="text-2xl font-bold text-center mb-4 text-green-700">Painel Admin - Reservas</h1>

<div id="filtro" class="mb-4 text-center">
  <button id="btn-atualizar" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold">Atualizar Reservas</button>
</div>

<div id="reservasContainer" class="grid-card"></div>

<script>
const backendURL = "http://localhost:10000"; // Use localhost se estiver rodando local
const ADMIN_USER = "silvano_Silsa"; // do seu .env
const ADMIN_PASS = "53711910_Silsa"; // do seu .env

async function fetchReservas() {
  try {
    const response = await fetch(`${backendURL}/reservas`, {
      headers: {
        "Authorization": "Basic " + btoa(ADMIN_USER + ":" + ADMIN_PASS)
      }
    });
    if (!response.ok) throw new Error("Erro ao buscar reservas");
    const data = await response.json();
    displayReservas(data.reservas);
  } catch (err) {
    console.error(err);
    document.getElementById("reservasContainer").innerHTML =
      `<p class="text-red-600">Não foi possível carregar reservas.</p>`;
  }
}

function displayReservas(reservas) {
  reservas.sort((a,b) => new Date(a.datahora) - new Date(b.datahora));
  const container = document.getElementById("reservasContainer");
  container.innerHTML = "";

  reservas.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    // Links das localidades
    const partidaLink = r.partida ? `<a class="link-viagem" href="https://www.google.com/maps/search/${encodeURIComponent(r.partida)}" target="_blank">${r.partida}</a>` : "—";
    const destinoLink = r.destino ? `<a class="link-viagem" href="https://www.google.com/maps/search/${encodeURIComponent(r.destino)}" target="_blank">${r.destino}</a>` : "—";

    // Motorista próximo (exemplo: 4 horas de diferença)
    const motoristaProximo = r.motoristaProximo ? `Motorista próximo: ${r.motoristaProximo.nome} (${r.motoristaProximo.hora.toLocaleString()})` : "Nenhum motorista próximo";

    const enviadoText = r.paraMotorista ? "Enviado para motorista" : "Não enviado";

    card.innerHTML = `
      <p><strong>Nome:</strong> ${r.nome}</p>
      <p><strong>Categoria:</strong> ${r.categoria || "—"}</p>
      <p><strong>Email:</strong> ${r.email}</p>
      <p><strong>Partida:</strong> ${partidaLink}</p>
      <p><strong>Destino:</strong> ${destinoLink}</p>
      <p><strong>Data:</strong> ${r.datahora ? new Date(r.datahora).toLocaleString() : "—"}</p>
      <p><strong>Valor:</strong> ${r.valor} €</p>
      <p><strong>Código:</strong> ${r.codigo || "—"}</p>
      <p><strong>Status:</strong> <span class="${r.paraMotorista ? 'text-green-600' : 'text-red-600'}">${enviadoText}</span></p>
      <p>${motoristaProximo}</p>
      <div class="mt-2 flex gap-2">
        <button class="btn btn-nao" onclick="toggleMotorista('${r._id}', ${r.paraMotorista})">
          ${r.paraMotorista ? 'Cancelar Envio' : 'Marcar Envio'}
        </button>
      </div>
    `;
    container.appendChild(card);
  });
}

async function toggleMotorista(id, statusAtual) {
  try {
    const response = await fetch(`${backendURL}/reservas/${id}/motorista`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Basic " + btoa(ADMIN_USER + ":" + ADMIN_PASS)
      }
    });
    if (!response.ok) throw new Error("Erro ao atualizar status");
    fetchReservas();
  } catch (err) {
    console.error(err);
    alert("Não foi possível atualizar o status da reserva.");
  }
}

document.getElementById("btn-atualizar").addEventListener("click", fetchReservas);
fetchReservas();
</script>

</body>
</html>
